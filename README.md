# screeps
I am new to screeps but want to put my code in case it helps anyone else.

This code is as of level 4.  I have looked at others code and adopted it.  This is very much still a work in progress.  I have not yet written any code to advance and take over other rooms.

I just finished a basic defense system with a tower and also defense creeps will be created if a hostile creep enters my room.

There is still much automation yet to create, more than I even know of.

This code is very very ugly, once I get it all figured out I want to re-write it in Classes or at a minimum restructure and make it pretty.

The ultimate goal is to be able to create a room, drop this code and let the room grow on it's with you only needed to put construction items when and where needed.

# TODO List
For the latest to do list look at the top of the main.js file.  That is where I am adding things as I think about them.  You will also find TODO: in the code.

# Changelog
I am going to start putting details about my changes I upload here instead of in the commit messages.  This will also be like a diary as to what I was thinking so in the future I can look and see why did some of the stupid things I did.

## 12-07-2016
* Created a stats.js file that when run will generate and email out game details like levels, progress to next level, room stats about level, memory settings, resources, creeps and their jobs, etc.  I setup a Date check function in the 100 ticks routine to check for when it is between 8 am or pm and 8:16.  If it is, the stats are run and emailed out.
* I modified all of the roles that look for a source of energy.  It used to be that every clock tick they would try to find the closest energy.  The findclosestbypath is a very expensive CPU operation.  Now, when they go looking for n energy source they run the findClosestByPath and remember the structure.  On the next clock tick they head towards that source without calculating the path, saving CPU time.  There is one negative side affect to this.  If while enroute to an energy source, all of the positions get full or the source runs out of energy, it will keep heading to that source.  The old way, it would change its course to the next closest source.  I can probably write some code that can check the source on each clock tick and if that happens, re-run the findClosestByPath process and keep going.  I have not done that yet.
* I have been tweaking values in the roomsManager values for each level.  I have a new room coming up through the levels and am adjusting as it progresses.
* I have started marking some messages with (SL) and (TX).  Any message that goes to my gmail from screeps with a (SL) will get posted to my screeps slack channel.  Any message that has (TX) will go to my slack channel and get texted over SMS.  This allows me to determine what additional notification I want to receive other than email.  I am doing by 2 applets in IFTTT.
* I am still modifying some of the old console.log and Game.notify code as I am finding it.
* I modified the defender.js to use the tower to repair ramparts that are close to going away.  Ramparts start out with a very low health and decay quickly.  If there is not a repairer there within 200 ticks it goes away.  If my builder is moving quickly, I might not get a repairer there that fast.  I do not spawn any rampart repairers unelss there are ramparts.  In the fast build process sometimes that repairer is a lower priory and may take a little bit to get spawned and then has to mine energy before it can sart the repair.  This just helps keep them alive long enough for a repairer to get there.
* I started on the stats calculation that will be used in remoteHarvesters and remoteUpgraders.  It will look at how long it takes it's trips and calculate if it costs more to build the creep than the energy that it harvests.  I am writing it currently on remoteHarvesters and will port it to remoteUpgraders once I get it working reliably.  If it thinks it is not efficent it will send a game notification with the details about each leg of it's trip.  There may be some adjustments that can be made.  I can see taking this a little further later to help tune even roles that are bringing in more energy than they cost.
* I changed the order of the statements in creeps.manager so that certain repairers have a higher priority.  The new room was so busy creating things that it did not create the rampart upgrader for while right after they were built and they got dangerously close to being destroyed.  This would normally not be a big deal after they have been established for a while but when the room is young it can make a big difference.  The rampart repairer is more important than spawning another upgrader.

## 12-06-2016
* Added body option to settings so that they can be overriden if needed on a per room per role basis.  If set to AUTOMODE then the same body parts are returned just like before.
* Modified builder role to look at the remote for the room to go build in.  Home should still be set to the room where it was spawned.  This is so that the active count routine can determine how many of this role it actually has based on the home memory setting and not the number in the current room.
* Modified repairer to work like builder mentioned above.  It now understands both home and remote and will go repair in whatever room is set in remote.
* created a routine in builder to look for work in the room where it is to go to.  This is used in screeps manager to see if a builder is needed in the remote room or the home room based on options in settings.
* created a builder2 and builder3 roles.  The actual work code is still role.builder, but now you can have 3 different builders doing different rooms, etc.  In every level, the default is 0 of builder 2 and builder3.  To activate them you have to override in the options.  This is how I am sending builders to other rooms to do work without affecting my home room builders.
* Created a repairer2 and a repairer3 role.  It uses the exact same code module as the regular repairer role.  In the work role.controller it has all 3 role names in the case for role.repairer.  This was done so that I can send repairers to other rooms without affecting my home room.  By default every level is set to 0 of both new roles.  To activate the roles you need to override the default and change from AUTOMODE to a number to spawn for each room.
* I moved the roleDefender call from the main loop to the creeps.manager.  In the main loop it was only calling the home room.  I could have added another for the 2nd room but since creeps.manager is called for ever room it seemed more logical to just place it in screeps.manager.
* I added a new function in a new file called alerts.  Instead of doing a console.log or Game.notify, you now call this function with a alerts level and the message.  The lower the number the more important.  For example, Attacked and level changes are level 1, new creeps are level 2, old creeps memory erasing is level 3, more details like rampart repair levels increasing are level 4, level 5 is the first debugging and 6 is the insane debugging level.  In the settings.js file you can set what level you want to write to the console and the level that you want to get an email for.  I am still going through code converting to this new function.
* In roomsManager I added 2 new functions: getRemoteRoom and getHomeRoom.You pass in the room name and the role and you get back either the remote room or the home room name.  This is used when looking for work in a room as mentioned above in the a prior change today.

## 12-05-2016
* Modified screepsManager to not create rampart repairers if there are no ramparts.
* Modified screepsManager to not create wall repairers if there are no walls.
* Modified the emergencyRepairMode to look at each room independantly so that the entire game does not go into emergency repair mode.  This was mosly a change in the 20 second timer to loop rooms.

## 12-04-2016

Today's updates were not really planned to be this fast.  I thought I had a few days before I would be going to multiple rooms but my neighbor who was on both my west and east side respawned to start over.  He said he was not coming back to them so I setup shop in the room to my east and started harvesting from the west as well.  The following changes were made in real haste but so far seem to be working.  There are a few things that you will see in the main.js files at the top that are notes of things that are not working.

* Finished the roomsManager code.  Added some more code to return the memory objects as well.  There were a lot of little changes to this file.  There are some new roles that needed added, etc.
* In the screeps manager there are lots of changes.  The first was to change the filters to look for number of creeps per role per room.  This still needs some more work because if you set a creep out on a remote job, it lowers the count when it leaves the room.
* In Screeps manager, now every creation looks to roomsManager to get the correct body parts and the correct memory settings based on the level of the room, and the current mode of the room.
* In screeps manager, the number of creeps per role is determined based on the current level of the room and the mode of the room.
* In screeps manager, it now uses the room name that is passed in to detemrine what needs to be done for that room.
* In main.js there is a second line to handle the new room, I started working on a loop togo through all rooms but never got around to completing it.
* In settings there is not a structure to define the options for each room.  If in AUTO mode everything is based on the level and mode of the room.  Things can be overriden here.  This is where I changed a couple of parameters to get the upgraders and builders over to the new room until the spawn was built.
* I wrote an attacker role because my neighbor had walls up that I needed to get through in both rooms.  This was my first attempt at this and it needs to be completely re-written.
* I modified both the wallRepairer and rampartRepairer to store the current repair value in the room and not the game level memory where it was.  There is still more to chnage in there if my little test works which I suspect it will but did not want to break anything before I went to bed.
* I started working on a new upgrade role that I hope to use as the single upgrader code for both in room and out of room uprading.  For now due to the time crunch I was under I wrote something just to keep upgraders working on the new room controller until I could get it to level 2 where I could build a spawn.  These are no longer in use but it is a good base to build a flexible module.
* I put my first attempt at automating the room into the 100 tick timer.  Every 100 ticks it will look to see if the level has changed.  If it has it will put it into NEWROOM mode (which for now is the same settings as it was at the previous level) and send an email.  The email states that constructions sites need to be created.  Once they are and the timer fires, it will move into BUILD mode until all consutruction has been completed, once it sees that construction is complete it will move in the GROW mode which.  In every mode a builder is created if there is a need for a builder but non will spawn if there are no construction sites.  But in BUILD mode more of them spawn.


## 11-30-2016

* Added 3 timers, one that fires every 10 game ticks, one that fires every 20 game ticks and one that fires every 100 game ticks.  I am going to put some automation stuff in these timers becuase some things do not need to be checked every game tick.  I am already startig to see CPU spikes so the more work I can defer if it is not needed the better.
* I setup the builders to not spawn if there are no construction sites.  Why build a builder if they are not needed.  As soon as a construction site pops up, it will spawn whatever the builder count is for this level.
* I setup the wall repairer so that if there are no builders, to spawn twice the size of the regular wall repairer.  This was in an effort to speed up the wall repairs.  My current room has A LOT of walls.  Plus I did not know better and I made them double width.  Hopefully they will get more work done faster when there is no construction going on.
* I created a new automatic mode that I mentioned yesterday.  Using the timers mentioned above, every 20 ticks I check to see if there is a need for an emergency repairer.  I based that on some variables that are easily adjusted.  My initial try that is running now is that if any structure gets to 10% or below or there are more than 50 structures at 50% or below then there is a need to enable the emergency repairer mode.  The emergency repairer will stay until there are less than 10 in need of repair at 50%.  When it starts, it looks for any structure that is below 10% and fixes them first, then goes to 20, then 30 then 40 and then on to 50.  That way the structures that are in the worst shape are tended to first.  Once it is less than 10 at 50% it will exit the emergency repair mode and there will be no more spawns of the emergency repairer until it is needed again.  In the future I will adjust the different chagne points for number of things needed to be repaired to a percentage.  50 works good for my current room but I have a lot of roads.  With less roads that number would not make sense.
* I created a new file called settings where I am defining options for how the scripts run.  This will be the one file where adjustments can be made.  This saves going through all of the code to make changes in multiple files.  This is pretty small at the moment but it will grow quickly, especially when I have to start settings options for multiple rooms.
* I created a constants file, similar to the settings file above so that constants for commonly used items can be created for ease of readability, consistency, etc.
* I converted the long list of if then statements that were used in every loop for every creep to send it to the correct job.  I converted it to a case statement.  If the first it statement matched, every one below it would check too.  That is inefficient, with the case, once it finds it it drops out.  Plus it looks much neater now.
* I modified the emergency repairer a little more, once the criteria for exiting the mode the emergency repair creep stopped working.  I modified it so if it is done in emergency mode, it will keep working until it dies fixing anything that is less than 90% health.  That can help the regular repair creep get some more work done before it is time.
* I added some more to the rooms manager, getting closer to getting back all of the details based on room level and room mode.  I need to figure out to handle multiple rooms when I do this so I do not have to come back and re-write that.  I am getting much closer to multiple rooms now.  I have some stuff already but need to make it easy to configure.

## 11-29-2016

* Change the repairer role to deliver all of the energy the repairer has or until the structure being repaired is 100% fixed.  This was causing a problem.  It was repairing a structure when it got below 50%.  But it would only repair to just over 50% so it was going back to that same structure frequently and not visiting other structures.  Because I am just looping by the structure ID it always starts at the same place.  I figured this out when I started seeing my roads disapear.  This prompted me to create a new role called emegencyRepairer (See next change).
* I created a new role called emergencyRepairer as mentioned above.  This creep is larger than the repairer creep and instead of looking at the first thing it finds that needs help it looks at the 3rd one if there is one or the second one if there are only 2 and it will fallback to the first one if there is only one.  The reason was so that the workload can be spread out easier.  This will not be a regular creep, I plan on making an emergency repair mode that is automatic so if something like happened to me where the repairer would stop working or get really behind, this creep would spawn and help out until things are caught up.  More on this later as I have not written all of the logic yet.
* I changed how the creepManager decides what needs to spawn.  It was done as an independant set of if statements to see what needed a spawn.  The problem was, some things would not spawn because there was not enough energy but a smaller creep would spawn and use the energy.  This was happening to my harvesters.  So now, I am using if then else statements and the creeps needs are looked at in order of priority.  So if a harvester is needed, it has top priority, nothing else will spawn until that need is met.  This seemed to fix my running out of harvesters issue, however I still want to create the emergency recovery mode, just in case you are attacked and wiped out.
* I created a new role for repairing ramparts called rampartsRepairer.  I had this grouped into the regular repairer role first.  However, because of the previous discussion on the problem I had with the repairer I broke it out.  And it is better this way.  I now have a dedicated repairer for the ramparts.  Since they are created with very little hit points left and decay quickly I did some things a little different.  Instead of going to one and sticking with until it is 50% or more healthy (at 10 millions hit points and starting out at 100 hit points, that would take one repairer days) I started a search for a rampart that is less than .01% healthy, I then go to each of them and use up the entire energy store in my creep to repair as far as I can.  Once that rampart is now more than .01% healthy I go the next one and do the same thing.  Once all ramparts are healthy above .01% I increase to .02% automatically and do it all over again.  This will slowly walk up the health of all of the ramparts.
* Similarly to the ramparts repairer, I did the same thing with the walls.  When they are built, paper walls would be stronger, they are created red (which I did not know what that meant originally).  With a total health of 300 million and a starting health of 10 I think, it could take months for a single creep to repair just one piece of wall.  I took the approach I did with ramparts, I start looking for .0001% health and repair them to above that.  Once they are all above .0001% I increase that to .0002% automatically and start all over and it just keeps going.  It is not fast but it is consistent.  I am thinking of creating a special version of the creep when there are no builders building stuff.  Look for that later.
* I created a remoteHarvester role that will go to a different room to harvest energy and bring it back and deliver it like a regular harvester.  This was an experiment and I tried all kinds of different body part configurations to see which one worked the best.  The room I was harvesting from was to my west and my neighbor to the east wanted to take over that room so I had to shut these down.  More to come on these later when I get another room.
* I created a remoteUpgrader role that like the remoteHarvestor role above goes to another room to harvest energy and brings it back to upgrade the room controller.
* I modified the builders to look for the closest source for energy.  They were originally hard coded to go to a specific energy source.
* I modified the harvesters to look for the closest source for energy.  They were originally hard coded to go to a specific energy source.
* I cleaned up the console log output so it is less busy when a creeps is needed to spawn or one does.  I also added an output when one expires to you can see what type of creep expired.
* In the creeps manager I put at the top constants for the number of each type of creep so that it is no longer needed to go scrolling through a bunch if if then else statements looking for the right thing.  Once the room manager is complete, this would be how to override the automation process.
